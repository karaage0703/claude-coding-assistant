# プルリクエスト自動コードレビュー

## 概要
GitHub CLIを使用してプルリクエストを自動分析し、体系的なコードレビューを実行するプロンプト。PRテンプレートの観点に基づいて高品質なレビューコメントを効率的に提供する。

**マルチエージェント機能**: codex MCPサーバが利用可能な場合、作成したレビューコメントの妥当性をcodexに検証してもらい、より高品質で正確なレビューを実現します。

## 使用方法
```bash
# このプロンプトの実行方法
@code-reviewer.md PR#123をレビューしてください
```

## 適用場面
- プルリクエストの体系的なコードレビューが必要な場合
- GitHub上で直接コメントを投稿したい場合
- 複数ファイルにわたる変更を効率的にレビューしたい場合
- チーム内でのレビュー品質を統一したい場合

---

## プロンプト本文

あなたは経験豊富なシニアエンジニアです。以下の手順でプルリクエストをレビューし、GitHub上にコメントを投稿してください。

## マルチエージェントレビューフロー

codex MCPサーバが利用可能な場合、以下のフローでレビューを実行：

```
1. PR分析（Claude）
   ↓
2. レビューコメントドラフト作成（Claude）
   ↓
3. 妥当性検証（Codex） ← マルチエージェント検証
   ↓
4. フィードバック反映（Claude）
   ↓
5. 最終コメント投稿（Claude）
```

**メリット**:
- 複数の視点からの検証により、レビューの質が向上
- 見落としや誤った指摘を事前に防止
- より実装可能で効果的な改善提案の提供
- セカンドオピニオンによる信頼性の向上

## レビュー手順

### 1. PR情報の確認
まず以下のコマンドでPRの基本情報を収集：

```bash
# PRテンプレートの確認（レビュー観点の把握）
cat .github/pull_request_template.md

# PR詳細情報の確認
gh pr view <PR番号> --json title,body,headRefOid,baseRefName,headRefName,files,additions,deletions

# PR差分の全体確認
gh pr diff <PR番号>

# 変更されたファイル一覧
gh pr diff <PR番号> --name-only
```

### 2. ファイル別詳細分析
各変更ファイルについて以下を実行：

```bash
# 変更後のファイル全体の確認
cat <ファイルパス>

# 特定ファイルの差分詳細
gh pr diff <PR番号> -- <ファイルパス>
```

### 3. レビュー観点の適用
PRテンプレート（.github/pull_request_template.md）に記載された観点、または以下の標準観点でレビュー：

- **機能性**: 実装が要件を満たしているか
- **可読性**: コードが理解しやすいか、命名は適切か
- **保守性**: 将来の変更に対して柔軟性があるか
- **パフォーマンス**: 効率的な実装になっているか
- **セキュリティ**: セキュリティリスクはないか
- **テスト**: 適切なテストが含まれているか
- **ドキュメント**: 必要な文書化がされているか

### 4. レビュー内容のドラフト作成
問題を発見した箇所について、まずレビューコメントをドラフトとして準備：

**重要度の判定基準**:
- **【必須】**: セキュリティ、バグ、データ損失リスクなど即座の修正が必要
- **【推奨】**: パフォーマンス、保守性、可読性の大幅な改善が見込める
- **【提案】**: より良い実装方法の提案、将来的な改善案

### 5. Codexによるレビュー妥当性確認（必須）

レビューコメントを投稿する前に、必ずCodex MCPサーバで妥当性を検証します。これにより、誤った前提や技術的な誤りを防ぎます。

#### ステップ5.1: Codex動作確認（レビュー開始時に1回実施）

まず、簡単なテストでCodexが動作するか確認します：

```
Hello, this is a test. Please respond with "Test successful".
```

**期待される応答:** `Test successful`

**動作確認結果:**
- ✅ **成功**: ステップ5.2に進んで妥当性検証を実施
- ❌ **失敗（60秒以上応答なし）**: Codexなしでレビューを続行（ステップ6へ）

**注意:** 初回起動時は10-20秒かかる場合があります。

#### ステップ5.2: レビューコメントの妥当性検証

Codexが動作することを確認できたら、作成したレビューコメントの妥当性を検証します。

**Codexへの確認プロンプト例**:
```
以下のコードレビューコメントの妥当性を、シニアエンジニアの視点で検証してください：

【対象ファイル】
<ファイルパス>

【変更内容】
<該当する差分>

【レビューコメント案】
<作成したレビューコメント>

【確認観点】
1. 指摘内容は技術的に正確か
2. 重要度の判定は適切か
3. 改善提案は実装可能で効果的か
4. より良い代替案はないか
5. 見落としている問題はないか

検証結果を以下の形式で回答してください：
- ✅ 妥当性: 高/中/低
- 📝 改善提案: （あれば）
- ⚠️ 追加指摘: （あれば）
```

**Codexからのフィードバック活用**:
- **妥当性が「低」**: レビューコメントを修正または削除
- **改善提案がある場合**: コメント内容をブラッシュアップ
- **追加指摘がある場合**: 新たなレビューコメントとして追加
- **技術的誤りの指摘**: 必ず実装を再確認し、正確なレビューに修正

### 6. レビューコメントの投稿
Codexの検証を経て（または単独で）、以下のコマンドでコメント投稿：

```bash
# 最新コミットIDの取得
COMMIT_ID=$(gh pr view <PR番号> --json headRefOid --jq .headRefOid)

# レビューコメントの投稿
gh api repos/<owner>/<repo>/pulls/<PR番号>/comments \
  -F body="【<重要度>】<問題の説明>

<改善提案>

<補足説明（必要に応じて）>

---
🤖 **Reviewed by Claude Code**" \
  -F commit_id="$COMMIT_ID" \
  -F path="<ファイルパス>" \
  -F position=<diff行番号>
```

パラメータの説明：
- `position`: diffの行番号（新規ファイルの場合は1から開始）
- `commit_id`: PRの最新のコミットIDを自動取得
- `重要度`: 【必須】【推奨】【提案】のいずれか

### 7. サマリーレビューの投稿
全ファイルのレビュー完了後、総括コメントを投稿：

**注意**: サマリーもcodexで検証することで、見落としや全体的な視点からの追加指摘を得られます。

```bash
gh pr review <PR番号> --comment --body="## レビューサマリー

### 全体評価
- 変更ファイル数: <数>
- 重要な問題: <数>件
- 推奨改善: <数>件

### 主な指摘事項
1. [重要] <主要な問題1>
2. [推奨] <改善提案1>

### 良い点
- <評価できるポイント1>
- <評価できるポイント2>

### 次のステップ
<修正後の確認方法や追加で必要な作業>

---
🤖 **Reviewed by Claude Code**"
```

## レビューコメントの原則

### コメントの構成
1. **重要度ラベル**: 【必須】【推奨】【提案】
2. **問題の説明**: 何が問題かを具体的に記述
3. **改善提案**: 具体的な修正方法を提示
4. **補足説明**: 必要に応じて理由や影響を説明

### 良いコメント例

【必須】SQLインジェクション脆弱性

ユーザー入力をそのままSQL文に埋め込んでいるため、SQLインジェクション攻撃を受ける可能性があります。

改善提案:
```sql
// 現在
query = "SELECT * FROM users WHERE id = " + userId;

// 推奨
query = "SELECT * FROM users WHERE id = ?";
stmt = connection.prepareStatement(query);
stmt.setInt(1, userId);
```

プリペアドステートメントを使用することで安全にクエリを実行できます。

---
🤖 **Reviewed by Claude Code**


### 避けるべきコメント
- 「良くない」「微妙」などの曖昧な表現
- 個人的な好みに基づく指摘
- 修正方法を提示しない批判のみのコメント
- 攻撃的・否定的な表現

## 実行例

### 基本的なレビューフロー

```bash
# PR#123のレビュー開始
gh pr view 123 --json title,body,headRefOid,files

# 差分確認
gh pr diff 123

# ファイル別分析
gh pr diff 123 -- src/auth.js
cat src/auth.js
```

### Codexによる妥当性確認フロー（推奨）

```
# ステップ1: レビューコメントドラフト作成
【必須】パスワードハッシュ化が不十分

現在のハッシュ化方式（MD5）は安全ではありません。

改善提案：bcryptライブラリを使用してください。
```javascript
const bcrypt = require('bcrypt');
const hashedPassword = await bcrypt.hash(password, 10);
```

# ステップ2: Codexに妥当性確認を依頼（会話内でcodexツールを使用）
# 以下のような形でcodexに確認してもらう：

"以下のコードレビューコメントの妥当性を検証してください：

【対象ファイル】src/auth.js

【変更内容】
- const hash = md5(password);
+ const hash = await hashPassword(password);

【レビューコメント案】
【必須】パスワードハッシュ化が不十分
現在のハッシュ化方式（MD5）は安全ではありません。
改善提案：bcryptライブラリを使用してください。

【確認観点】
1. 指摘内容は技術的に正確か
2. 重要度の判定は適切か
3. 改善提案は実装可能で効果的か
4. より良い代替案はないか
5. 見落としている問題はないか"

# ステップ3: Codexからのフィードバック例
✅ 妥当性: 高
📝 改善提案: saltラウンド数の説明を追加すると親切
⚠️ 追加指摘: 既存のMD5ハッシュからの移行方法も言及すべき

# ステップ4: フィードバックを反映して最終版を作成・投稿
COMMIT_ID=$(gh pr view 123 --json headRefOid --jq .headRefOid)
gh api repos/owner/repo/pulls/123/comments \
  -F body="【必須】パスワードハッシュ化が不十分

現在のハッシュ化方式（MD5）は安全ではありません。

改善提案：bcryptライブラリを使用してください。
```javascript
const bcrypt = require('bcrypt');
// saltラウンド数10は推奨値（セキュリティと性能のバランス）
const hashedPassword = await bcrypt.hash(password, 10);
```

補足：既存ユーザーのパスワード移行については、次回ログイン時に再ハッシュ化する方式を推奨します。

---
🤖 **Reviewed by Claude Code**
✅ **Validated by Codex**" \
  -F commit_id="$COMMIT_ID" \
  -F path="src/auth.js" \
  -F position=15

# レビュー完了後のサマリー
gh pr review 123 --comment --body="## レビューサマリー
全体的に良い実装ですが、セキュリティ面で2点の修正が必要です。

---
🤖 **Reviewed by Claude Code**
✅ **Validated by Codex**"
```

## 注意事項
- GitHub CLI（gh）がインストール・認証済みであることを確認
- PRテンプレートが存在しない場合は、標準的なレビュー観点を適用
- 大量の変更がある場合は、重要度の高い問題から優先的にコメント
- 建設的で具体的なフィードバックを心がける
- 初学者でも分かるように、専門用語には補足を入れ、丁寧にコメントする
- **レビュー開始時に必ずCodex動作確認テストを実施すること**
- Codexテストが成功した場合は、レビューコメントの妥当性確認を実施すること
- Codexによる検証を経たコメントには `✅ Validated by Codex` を署名に追加すること

## 使用方法

このプロンプトは以下のように使用します：

1. **環境準備**: GitHub CLIのインストールと認証
2. **プロンプト実行**: 上記内容を実行してPR番号とリポジトリ情報を指定
3. **自動レビュー**: 指定されたPRを自動分析してコメント投稿
4. **結果確認**: 投稿されたコメントをGitHub上で確認

## 特徴
- **完全自動化**: PRの取得からコメント投稿まで一貫した処理
- **体系的分析**: PRテンプレートに基づく統一されたレビュー観点
- **実用的フィードバック**: 具体的な改善提案を含むコメント
- **効率的処理**: ファイル別の段階的レビューで見落としを防止
- **マルチエージェント検証**: codex MCPサーバによる妥当性確認で高品質なレビューを実現
- **セカンドオピニオン**: 複数の視点から検証することで、誤った指摘や見落としを防止